# MoCo v2 Configuration
# Reference: He et al. 2020 (v1), Chen et al. 2020 (v2)

moco:
  encoder: resnet50        # ResNet backbone: resnet18 or resnet50
  dim: 128                 # Projection head output dimension
  queue_size: 65536        # Number of negative keys in the queue
  momentum: 0.999          # EMA coefficient for the key encoder
  temperature: 0.07        # InfoNCE temperature (lower = sharper)
  var_loss_weight: 1.0     # VICReg variance term weight — penalises dead embedding dims (0 = off)

training:
  run_name: moco-resnet50-v3-vicreg
  batch_size: 384          # L4 22GB usable: 512+ OOMs due to encoder_q activation graph
  lr: 4.5e-2               # SGD learning rate (scaled by batch size: 0.03 * bs/256)
  weight_decay: 1.0e-4
  epochs: 800              # More passes compensates for small dataset size
  warmup_epochs: 10
  grad_clip: 3.0           # Gradient clipping for stability
  compile: false           # torch.compile breaks on MoCo queue ops
  checkpoint_every: 50
  output_dir: outputs/moco-v3

data:
  image_size: 224
  num_workers: 14           # 16 vCPUs — leave 2 for main process + OS
  cache_in_ram: true   # load all PNGs into RAM on startup (~2 GB), eliminates disk I/O
  datasets:
    - name: nih
      root_dir: datasets/nih-chest-xrays
      # txt_file omitted — use all 112k images for pretraining
    # - name: chexpert
    #   root_dir: /data/chexpert
    # - name: mimic-cxr
    #   root_dir: /data/mimic-cxr

augmentations:
  random_crop_scale: [0.08, 1.0]  # was [0.2, 1.0] — aggressive crops force local feature learning
  rotation_degrees: 10             # ±10° — models realistic patient positioning variation
  color_jitter_prob: 0.8
  color_jitter_brightness: 0.8    # was 0.4 — simulates exposure/kVp variation
  color_jitter_contrast: 0.8      # was 0.4 — simulates window/level variation
  gaussian_blur_prob: 0.5
  gaussian_blur_kernel: 9
  gaussian_noise_std: 0.1         # new — simulates X-ray quantum (Poisson) noise
